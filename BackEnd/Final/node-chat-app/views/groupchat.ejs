
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅방에 접속한 모든 그룹 사용자간 채팅</title>
</head>
<body>
    <h1>채팅방 기준 그룹 사용자간 채팅</h1>
    Step1: 닉네임을 입력한다. <br/>
    Step2: 채팅방을 개설하고, 입장한다. <br/>
    Step3: 채팅방에서 사용자간 채팅을 진행한다. <br/>

    닉네임: <input type="text" id="nickname"/> <br/>
    채팅방명: <input type="text" id="channel"/>

    <button id="btnEntry">입장</button>
    <button id="btnExit">퇴장</button> <br/><br/>

    메시지: <input type="text" id="message"/> <br/>
    <button id="btnSend">전송</button>

    <!-- 채팅 수신 이력 표시 영역 -->
    <ul id="chatHistory">
    </ul>


    <!-- 클라이언트 코딩을 위한 jquery cdn 라이브러리 참조-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- socket.io javascript library 참조-->
    <script src="/socket.io/socket.io.js"></script>


    <!-- 프론트엔드 코딩 영역입니다. 웹브라우저에서 실행됩니다. -->
    <script>
        // 클라이언트(웹브라우저)와 서버 연결 소켓 객체 정의
        // 서버 소켓과 연결을 시도하고, 연결이 완료되면 연결이 지속된다.
        // io.connect('/')를 통해 서버소켓과 연결을 완료하고, 서버로 메시지를 보낼 socket객체가 반환된다.
        var socket = io.connect('/');

        // Jquery에서 html 요소의 id값으로 html요소를 찾는다. -> $("#html요소의 id값")
        $("#btnSend").click(function() {
            

            // 사용자 닉네임과 메시지 입력값을 추출한다.
            var Nickname = $("#nickname").val(); // input 박스에서 값을 가져온다.
            var Message = $("#message").val();

            var msgData = {
                Channel: $("#channel").val(),
                Nickname,
                Message
            };

            // socket.emit('서버 이벤트 수신기명', '서버로 보낼 전송 데이터');
            socket.emit('channelMsg', msgData); // 서버소켓의 그룹채팅 메시지 수신기를 호출한다.

        })

        // 서버에서 보내준 메시지를 수신하는 수신기 정의하기
        // 클라이언트 이벤트 메시지 수신기 정의
        socket.on('receiveAll', function(serverMsg) {
            // 서버에서 보내준 메시지 문자열을 포함한 li 태그를 하나 만들고, ul태그에 li태그를 추가한다. -> .append()
            $("#chatHistory").append(`<li>${serverMsg}</li>`); // chatHistory태그 안에 요소를 추가한다.
        });

        // 그룹 채팅 서버 메시지 수신기 정의
        socket.on('receiveChannel', function(serverMsg) {
            // 서버에서 보내준 메시지 문자열을 포함한 li태그를 하나만들고
            // ul태그에 li태그를 추가한다.(append())
            $("#chatHistory").append(`<li>${serverMsg}</li>`); // chatHistory태그 안에 요소를 추가한다.
        });


        // 입장 버튼 클릭 시 입력한 채팅방(채널)에 특정 닉네임을 입장
        $("#btnEntry").click(function() {
            // 닉네임과 채널명을 UI 요소에서 추출한다.
            const Nickname = $("#nickname").val();
            const Channel = $("#channel").val();

            // 서버소켓의 entry라는 이벤트를 호출한다.
            // 채널명과 대화명을 파라미터로 전달한다.
            // socket.emit('서버 소켓 이벤트 수신기명', 전달할 데이터...);
            socket.emit('entry', Nickname, Channel);
        });

        // 채팅방 입장 완료 후 입장완료 메시지 수신기 기능 구현
        socket.on('entryOk', function(entryMsg) {
            $("#chatHistory").append(`<li>${entryMsg}</li>`); // chatHistory태그 안에 요소를 추가한다.
        });


        // 현재 채널(채팅방) 퇴장
        $("#btnExit").click(function() {
            const Nickname = $("#nickname").val();
            const Channel = $("#channel").val();

            socket.emit('exit', Nickname, Channel);
        });

        // 채팅방 퇴장완료 메시지 수신기
        socket.on('exitOk', function(exitMsg) {
            $("#chatHistory").append(`<li>${exitMsg}</li>`);
        });

    </script>
</body>
</html>